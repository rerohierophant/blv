<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>朋友圈</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'css/pyq_index.css' %}">
    <script type='text/javascript' src="{% static 'js/jquery.min.js' %}"></script>

</head>
<body>
    <audio style="display: none;" controls="controls" hidden id="audio" autoplay="true">123</audio>
    <div class="header">
        <button id="return-pyqs">
            <svg t="1708333582117" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4370" width="200" height="200"><path d="M631.04 161.941333a42.666667 42.666667 0 0 1 63.061333 57.386667l-2.474666 2.730667-289.962667 292.245333 289.706667 287.402667a42.666667 42.666667 0 0 1 2.730666 57.6l-2.474666 2.752a42.666667 42.666667 0 0 1-57.6 2.709333l-2.752-2.474667-320-317.44a42.666667 42.666667 0 0 1-2.709334-57.6l2.474667-2.752 320-322.56z" fill="#111111" p-id="4371"></path></svg>        </button>
        <span>朋友圈{{ pyq.pyq_id }}</span>
    </div>
    <div class="post">
        <div class="post-header">
            <img class="avatar" src="{{ pyq.poster_avatar }}" alt="头像">
            <div class="post-user-details">
                <span class="username">{{ pyq.poster }}</span>
                <span class="post-time">{{ pyq.time}}</span>
                <span class="post-location">{{ pyq.location}}</span>
            </div>
        </div>
        <div class="post-body">
            <div class="post-content">{{ pyq.content }}</div>
            <div class="post-image" id="post-img">
                {% for img in pyq.img_set.all %}
                <img src="{{ img.img_url }}" alt="图片" data-img-id="{{ img.img_id }}" data-pyq-id="{{ pyq.pyq_id }}">
                {% endfor %}
            </div>
        </div>
        <div class="post-footer">
            <div class="button-bar">
                <button class="like-btn" id="toLike">
                    <svg t="1707124504128" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6761" width="200" height="200"><path d="M621.674667 408.021333c16.618667-74.24 28.224-127.936 34.837333-161.194666C673.152 163.093333 629.941333 85.333333 544.298667 85.333333c-77.226667 0-116.010667 38.378667-138.88 115.093334l-0.586667 2.24c-13.728 62.058667-34.72 110.165333-62.506667 144.586666a158.261333 158.261333 0 0 1-119.733333 58.965334l-21.909333 0.469333C148.437333 407.808 106.666667 450.816 106.666667 503.498667V821.333333c0 64.8 52.106667 117.333333 116.394666 117.333334h412.522667c84.736 0 160.373333-53.568 189.12-133.92l85.696-239.584c21.802667-60.96-9.536-128.202667-70.005333-150.186667a115.552 115.552 0 0 0-39.488-6.954667H621.674667zM544.256 149.333333c39.253333 0 59.498667 36.48 49.888 84.928-7.573333 38.144-21.984 104.426667-43.221333 198.666667-4.512 20.021333 10.56 39.093333 30.912 39.093333h218.666666c6.101333 0 12.16 1.066667 17.909334 3.168 27.445333 9.984 41.674667 40.554667 31.776 68.266667l-85.568 239.573333C744.981333 838.026667 693.301333 874.666667 635.402667 874.666667H223.498667C194.314667 874.666667 170.666667 850.784 170.666667 821.333333V503.498667c0-17.866667 14.144-32.448 31.829333-32.821334l21.866667-0.469333a221.12 221.12 0 0 0 167.381333-82.56c34.346667-42.602667 59.146667-99.306667 74.869333-169.877333C482.101333 166.336 499.552 149.333333 544.266667 149.333333z" fill="#000000" p-id="6762"></path></svg>
                </button>
                <button class="comment-btn" id="toggle-recognition">
                    <svg t="1707133925660" class="icon" viewBox="0 0 1171 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4869" width="200" height="200"><path d="M821.510124 787.499968H660.432094c-5.365949 0-8.93956 1.792337-12.524235 5.377012l-89.49517 89.484107c-41.157378 41.168442-109.166627 41.168442-152.127407 0l-89.49517-89.484107a16.208484 16.208484 0 0 0-12.535299-5.377012H143.187847C64.435638 787.499968 0 723.075394 0 644.323184v-501.190656C0 64.435638 64.435638 0 143.187847 0h680.114614c78.75221 0 143.187847 64.435638 143.187847 143.176783v501.190657c-1.792337 78.75221-66.227975 143.176783-144.935929 143.176783z m0-71.58286a71.804136 71.804136 0 0 0 71.593923-71.593924v-501.190656a71.793072 71.793072 0 0 0-71.593923-71.58286H141.39551a71.782008 71.782008 0 0 0-71.58286 71.58286v501.190656a71.793072 71.793072 0 0 0 71.58286 71.616051h161.07803c23.234004 0 46.545455 8.93956 62.6433 26.840807l89.49517 89.49517c14.316572 14.316572 35.79143 14.316572 50.108002 0l89.49517-89.49517c16.108909-16.131037 39.376105-26.840806 62.643301-26.840807zM266.637855 340.057307c30.425481 0 53.692677 23.234004 53.692676 53.703741v35.791429c0 30.425481-23.234004 53.692677-53.692676 53.692677s-53.692677-23.234004-53.692677-53.692677V393.761048c0-30.436545 23.234004-53.703741 53.692677-53.703741z m214.770706 0c30.425481 0 53.692677 23.234004 53.692677 53.703741v35.791429c0 30.425481-23.234004 53.692677-53.692677 53.692677s-53.692677-23.234004-53.692676-53.692677V393.761048c0-30.436545 23.234004-53.703741 53.692676-53.703741z m214.781771 0c30.425481 0 53.692677 23.234004 53.692677 53.703741v35.791429c0 30.425481-23.234004 53.692677-53.692677 53.692677s-53.692677-23.234004-53.692677-53.692677V393.761048c0-30.436545 23.234004-53.703741 53.692677-53.703741z m0 0" fill="#000000" p-id="4870"></path></svg>
                </button>
            </div>
            <div class="divider"></div>
            <div class="user-behavior">
                <div class="likes" id="toggleLike" style="display: none;">
                    <svg t="1707140679253" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1661" width="200" height="200"><path d="M621.674667 408.021333c16.618667-74.24 28.224-127.936 34.837333-161.194666C673.152 163.093333 629.941333 85.333333 544.298667 85.333333c-77.226667 0-116.010667 38.378667-138.88 115.093334l-0.586667 2.24c-13.728 62.058667-34.72 110.165333-62.506667 144.586666a158.261333 158.261333 0 0 1-119.733333 58.965334l-21.909333 0.469333C148.437333 407.808 106.666667 450.816 106.666667 503.498667V821.333333c0 64.8 52.106667 117.333333 116.394666 117.333334h412.522667c84.736 0 160.373333-53.568 189.12-133.92l85.696-239.584c21.802667-60.96-9.536-128.202667-70.005333-150.186667a115.552 115.552 0 0 0-39.488-6.954667H621.674667z" fill="#5c6b84" p-id="1662"></path></svg>
                    <span>你</span>
                </div>

                <div class="comments">
                    {% for comment in pyq.comment_set.all %}
                    <span>{{ comment.commenter }}：{{ comment.comment_content }}</span>
                    {% endfor %}
                    <div id="comment-result">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="hover-box">
        <svg t="1707142709911" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3764" width="200" height="200"><path d="M565.265178 954.519092c-22.289934 0-48.400999-8.151747-67.952455-14.838727a103.425292 103.425292 0 0 1-26.875292-11.272338c-12.737105-7.769634-15.411897-8.342804-19.806198-24.773669 21.971506-5.158528 81.581157-41.905075 103.871091-55.342721 148.896757-89.159735 119.028246-10.444426 119.028246-364.981743 15.029784 3.566389 82.791182 32.415932 82.791182 57.316972 0 133.102747 20.570425 273.847757-52.604243 354.91943-22.799418 25.47421-91.834527 58.972796-138.388646 58.972796z m-433.061569-299.321966c258.626916 136.860193 184.369594 157.048504 357.721593 52.094759 44.579867-27.193719 90.433445-49.292596 132.593263-77.568969v101.896839c-95.528287 22.226248-272.319304 227.038896-419.050754 100.686815l-25.856323-25.155782c-37.319718-43.943012-45.344094-72.410442-45.344094-151.889977z m375.744596-19.105658c-19.933569-13.310275-79.479535-51.330533-101.896839-57.316972v-133.739602a1158.312326 1158.312326 0 0 0 101.896839-57.316973c43.943012 10.189684 70.690933 47.063603 114.633945 57.316973v127.371049c-17.831947 12.10025-95.846715 58.718054-114.633945 63.749211z m-426.693016-178.31947c0-63.685525-4.26693-90.306074 38.84817-145.776166 23.945757-30.88748 47.509402-39.612396 82.090641-57.953828v261.110652c44.134069 23.372588 83.873836 49.037854 129.345301 74.448379l131.765351 78.396881c-59.545966 15.921381-63.685525 61.32916-109.602788 33.753328-104.699003-62.730242-272.38299-129.345301-272.38299-243.91556z m866.123138 127.37105c0 79.543221-47.573087 161.188063-121.002497 178.31947v-165.582365c0-82.791182 9.743885-84.574377-48.910483-116.608196L565.265178 362.371082c15.79401-23.62733 22.608361-19.105657 48.146256-34.835982 41.714019-25.47421 39.039227-16.112438 117.053995 28.785857 94.190891 54.196382 216.849212 100.559444 216.849212 228.885777z m-541.326961-197.425127v-95.528287c43.751956-23.181531 90.688187-50.94842 133.357489-76.804743 82.154327-49.547338 95.528287-63.303412 185.006449-63.303412 48.464684 0 102.533695 36.746548 125.651541 65.405034 42.223503 52.22213 39.930824 92.662439 39.930824 151.125751-31.078536-16.494551-192.393971-121.002497-222.899337-121.002498s-229.650003 123.422547-261.110652 140.108155z m-50.94842 159.213812c-16.36718-10.95391-63.112355-39.99451-82.791183-44.579867 0-168.320842-33.880699-314.606493 67.952455-390.519639 56.043262-41.714019 113.169178-53.814269 181.376375-30.696423 25.47421 8.661231 35.536523 20.888852 56.36169 26.429493-11.781822 16.048752-80.68956 50.311565-102.278953 63.303412-154.564769 93.235608-120.620384 7.451206-120.620384 376.063024z m-292.953415 121.002498c0 169.148754 115.143429 280.853165 274.293556 273.847756 59.800708-2.674792 26.811606-7.705949 69.417222 25.47421 97.820966 76.741057 228.822091 73.747838 319.637649 1.018969a251.939936 251.939936 0 0 0 52.604244-55.661149c58.20857-85.274918-10.95391-45.598836 81.96327-83.619094 130.236898-53.241099 199.399378-217.358696 128.64476-355.428914-27.448461-53.559526-40.249252-28.849543-28.276373-104.699003 18.723544-118.582447-63.176041-230.032116-157.621674-269.771884-98.90362-41.586648-129.090559 12.737105-178.892639-37.574459A161.888604 161.888604 0 0 0 580.103905 28.913674C474.003821-27.766443 331.284559 1.528898 258.428319 93.681853c-81.326415 102.979494 9.489143 54.705866-92.407697 98.648878C15.149614 257.353652-33.251385 439.175825 41.579107 561.06992c56.807488 92.598753 20.570425 4.967471 20.570424 106.800625z" fill="#10A37F" p-id="3765"></path></svg>
    </div>

    <p id="response" style="margin: 0 0 0 16px;"></p>
    <button id="read-btn" style="margin: 0 0 0 16px;">朗读结果</button>

    <script>
        // 检查浏览器是否支持SpeechRecognition API
        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        if (typeof SpeechRecognition === "undefined") {
            alert("浏览器不支持");
        }

        var recognition_inquery = new SpeechRecognition();
        recognition_inquery.continuous = true; // 让识别服务不断运行
        recognition_inquery.lang = "zh-CN"; // 设置语言
        recognition_inquery.interimResults = false; // 是否返回临时结果
        var lastResult

        recognition_inquery.onresult = function (event) {
            lastResult = event.results[event.resultIndex][0].transcript;
            console.log("识别结果: ", lastResult);
            $.ajax({
                url: '/get_free_chat/',
                type: 'POST',
                data: JSON.stringify({desc: description, id: id, voice_input: lastResult }),
                contentType: 'application/json',
                headers: {'X-CSRFToken': getCookie('csrftoken')}, // 获取CSRF token
                success: function (response) {
                    console.log(response.data);
                    playAudio(response.audio_fp)
                    $("#response").html(response.data);
                },
                error: function (error) {
                    console.error(error);
                }
            });
        };
        recognition_inquery.onend = function () {
            console.log("识别服务断开");
        };

        var id = {{ pyq.pyq_id }};
        var comment = [];
        {% for comment in pyq.comment_set.all %}
            comment.push("{{ comment.commenter }}" + ":" + "{{ comment.comment_content }}");
        {% endfor %}
        var commentString = comment.join(";");
        var description = "发帖时间为{{ pyq.time }}，发帖地点为{{ pyq.location}}，发帖正文为{{ pyq.content }}，得到的评论为" + commentString;

        const hoverBox = document.querySelector('.hover-box');
        let click_timer = null;
        var isListening = false;

        document.addEventListener('DOMContentLoaded', function() {
            hoverBox.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (click_timer === null) {
                    click_timer = setTimeout(function() {
                        console.log('单击');
                        click_timer = null;
                        if (!isListening) {
                            console.log('开始语音识别');
                            recognition_inquery.start(); // 开始语音识别
                            isListening = true;
                        } else {
                            console.log('结束语音识别');
                            recognition_inquery.stop(); // 结束语音识别
                            isListening = false;
                        }
                    }, 300); // 300ms内无第二次触摸视为单击
                } else {
                    clearTimeout(click_timer);
                    click_timer = null;
                    console.log('双击');
                    dbclick_send_all();
                }
            });

            hoverBox.addEventListener('click', function (){
                if (!click_timer) {
                    click_timer = setTimeout(function() {
                        console.log('单击');
                        click_timer = null;
                        if (!isListening) {
                            console.log('开始语音识别');
                            recognition_inquery.start(); // 开始语音识别
                            isListening = true;
                        } else {
                            console.log('结束语音识别');
                            recognition_inquery.stop(); // 结束语音识别
                            isListening = false;
                        }
                    }, 300); // Wait for a potential second click
                } else {
                    clearTimeout(click_timer);
                    click_timer = null;
                    console.log('双击');
                    dbclick_send_all();
                }
            })
        })

        function dbclick_send_all(){
            $.ajax({
                url: '/get_result_all/',
                type: 'POST',
                data: JSON.stringify({desc: description, id: id}),
                contentType: 'application/json',
                headers: {'X-CSRFToken': getCookie('csrftoken')}, // 获取CSRF token
                success: function (response) {
                    console.log(response.data);
                    playAudio(response.audio_fp)
                    $("#response").html(response.data);
                },
                error: function (error) {
                    console.error(error);
                }
            });
        }

        function playAudio(src) {
            audio = document.getElementById('audio')
            audio.src = src
            audio.play()
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 定义朗读函数
        function speakText(text) {
            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);
            synth.speak(utterThis);
        }
    </script>

    <script>
        var img_timer = null;

        // var getAllImages = document.getElementsByTagName('img');
        // 如果不想看头像postImg = document.getElementById('post-img')
        let getAllImages = document.getElementsByTagName('img')
        // 循环所有图片（包括头像）
        document.addEventListener('DOMContentLoaded', function() {
            for (var i = 0; i < getAllImages.length; i++) {
                (function(x) {
                    getAllImages[x].addEventListener('touchend', function(e) {
                        e.preventDefault();
                        var img_src = this.getAttribute('src')
                        if (img_timer === null) {
                            img_timer = setTimeout(function() {
                                console.log('单击');
                                img_timer = null;
                                imgResponse(img_src);
                            }, 300); // 300ms内无第二次触摸视为单击
                        } else {
                            clearTimeout(img_timer);
                            img_timer = null;
                            console.log('双击');
                            saveEmbedding(img_src);

                            const imgId = this.getAttribute('data-img-id'); // 获取图片ID
                            saveImage(imgId, img_src); // 调用保存图片的函数
                            const pyqId = this.getAttribute('data-pyq-id');
                            window.location.href = `/pyqs/${pyqId}/image/${imgId}`;
                        }
                    });

                    getAllImages[x].addEventListener('click', function(e) {
                        e.preventDefault();
                        var img_src = this.getAttribute('src')
                        if (img_timer === null) {
                            img_timer = setTimeout(function() {
                                console.log('单击');
                                img_timer = null;
                                imgResponse(img_src);
                            }, 300); // 300ms内无第二次触摸视为单击
                        } else {
                            clearTimeout(img_timer);
                            img_timer = null;
                            console.log('双击');
                            saveEmbedding(img_src);

                            const imgId = this.getAttribute('data-img-id'); // 获取图片ID
                            saveImage(imgId, img_src); // 调用保存图片的函数
                            const pyqId = this.getAttribute('data-pyq-id');
                            window.location.href = `/pyqs/${pyqId}/image/${imgId}`;
                        }
                    });

                }(i))
            }
        })

        function imgResponse(img_src){
            // 使用 jQuery 发送 AJAX 请求到后端
            $.ajax({
                url: "/get_result_img/",
                type: "POST",
                data: JSON.stringify({ src: img_src, desc: description, id: id }),
                contentType: 'application/json',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }, // 获取CSRF token
                success: function(response) {
                    console.log(response.data); // 打印后端返回的响应
                    playAudio(response.audio_fp)
                    $("#response").html(response.data);
                },
                error: function(xhr, status, error) {
                    console.error(error); // 打印错误信息
                }
            });
        }


        function saveEmbedding(img_src){
            $.ajax({
                url: "/get_img_embedding/",
                type: "POST",
                data: JSON.stringify({ img_url: img_src }),
                contentType: 'application/json',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }, // 获取CSRF token
                success: function(response) {
                    console.log(response.data);
                },
                error: function(xhr, status, error) {
                    console.error(error); // 打印错误信息
                }
            });

        }

        function saveImage(imgId, imgSrc) {
            $.ajax({
                url: '/save_image/', // Django后端处理保存图片的URL
                type: 'POST',
                data: {
                    'img_id': imgId,
                    'img_url': imgSrc,
                    'csrfmiddlewaretoken': '{{ csrf_token }}' // 包含CSRF令牌
                },
                success: function(response) {
                    console.log('图片保存成功！');
                },
                error: function(error) {
                    console.log('图片保存失败：', error);
                }
            });
        }

    </script>


    <script src="{% static 'js/like_comment.js' %}"></script>

    <script type='text/javascript' src="{% static 'js/like_comment.js' %}"></script>

    <script >
        document.getElementById('return-pyqs').addEventListener('click', function() {
            window.location.href = '/';
        });
    </script>
</body>
</html>
